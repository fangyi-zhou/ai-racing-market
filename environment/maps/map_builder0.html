<!DOCTYPE html>
<html>
<head>
  <title>Map builder</title>
  <canvas id="canvas" width="1000" height="800" style="border:1px solid #000000;" tabindex="1"></canvas>
</head>
<body>
    <script>
      var context = canvas.getContext('2d');
      var zoom = 40;
      var h = canvas.height, w = canvas.width;
      var car_width = 0.5, car_height = 0.5;

      // Car for scale
      car_width = 0.5
      car_height = 1
      context.rect(0,0,zoom*car_width,zoom*car_height);
      context.stroke();


      // Draw grid
      var cell_size = car_width*zoom;
      for (var x = 0; x < w; x += cell_size) {
        context.moveTo(x, 0);
        context.lineTo(x, h);
      }

      for (var y = 0; y < h; y += cell_size) {
        context.moveTo(0, y);
        context.lineTo(w, y);
      }

      context.strokeStyle = "#ddd";
      context.stroke();

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

      function snap(x, m) {
        console.log(x, m)
        return Math.floor(x / m) * m;
      }

      function snap_point(point, m) {
        return [snap(point.x, m), snap(point.y, m)]
      }

      // Path drawing
      context.beginPath();
      context.strokeStyle = '#ff0000';
      first_point = true
      path = []
      canvas.addEventListener('mousedown', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        if (first_point) {
          first_point = false
        } else {
          context.lineTo(snap(mousePos.x, cell_size), snap(mousePos.y, cell_size));
        }

        context.moveTo(snap(mousePos.x, cell_size), snap(mousePos.y, cell_size));
        context.stroke();

        path.push(snap(mousePos.x - canvas.width / 2, cell_size) / zoom)
        path.push(snap(-(mousePos.y - canvas.height / 2), cell_size) / zoom)
        console.log(path)
      }, false);


      // Draw a new body
      paths = []
      canvas.addEventListener('keydown', function onKeyPress(evt){
        console.log(evt.keyCode)
        if (evt.keyCode == 13) { // Enter
          first_point = true
          paths.push(path)
          path = []
          console.log('All Paths')
          for (let i = 0; i < paths.length; i++) {
            console.log(paths[i])
          }
        }

        // if (evt.keyCode == 82) { // Redo
          // if (path.length > 0) {
            // path.pop()
            // path.pop()
          // }
        // }
      }, true);

    </script>
</body>
</html>
