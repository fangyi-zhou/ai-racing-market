<!DOCTYPE html>
<html>
<head>
  <title>Test demo - p2.js physics engine</title>
  <script src="p2.js/build/p2.js"></script>
  <script src="p2.js/demos/js/pixi.js"></script>
  <meta name="description" content="">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
  <script>
    // Hyperparameters
    var num_cars = 5
    var car_mass = 1
    var car_width = 8
    var car_height = 20
    var raceCars = []
    var fixedTimeStep = 1 / 2;
    graphics = new PIXI.Graphics();
    zoom = 3;

    // Create the PIXI renderer
    // var renderer = PIXI.autoDetectRenderer(600, 400),
    var renderer = PIXI.autoDetectRenderer(800, 450, null, false, true
    ),
    stage = new PIXI.Stage(0xFFFFAA);
    container = new PIXI.DisplayObjectContainer(),
    stage.addChild(container);
    document.body.appendChild(renderer.view);

    // Add transform to the container
    container.position.x =  renderer.width/2; // center at origin
    container.position.y =  renderer.height/2;
    container.scale.x =  zoom;  // zoom in
    container.scale.y = -zoom; // Note: we flip the y axis to make "up" the physics "up"

    // Abstract information required for car drawing
    function RaceCarGraphic (position, width, height, container) {
      this.position = position
      this.width = width
      this.height = height
      this.graphic = new PIXI.Graphics ();

      this.graphic.beginFill(0xFF0000);
      this.graphic.lineStyle ( 0.2 , 0x000000,  1)
      this.graphic.drawRect(position[0] - width/2, position[1] - width/2, width, height);
      container.addChild(this.graphic);
    }

    // Race Car
    function RaceCar (world, position, width, height, container) {
      this.vehicle = p2RaceCar (world, position, width, height);
      this.box_graphic = new RaceCarGraphic (position, width, height, container);

      this.updateGraphics = function () {
        this.box_graphic.position = this.vehicle.chassisBody.position

        // Here send the position to the front end
        this.box_graphic.graphic.position.x = this.box_graphic.position[0] - width / 2
        this.box_graphic.graphic.position.y = this.box_graphic.position[1] - height / 2
        this.box_graphic.graphic.rotation = this.vehicle.chassisBody.angle;
      }
    }

    // Send details of p2 race car to its graphical counterpart
    function updateGraphics (raceCars) {
      for (i = 0; i < raceCars.length; i++) {
        raceCars[i].updateGraphics ();
      }
    }

    // Create the p2 RaceCar
    function p2RaceCar(world, position, width, height) {
      // Create a dynamic body for the chassis
      chassisBody = new p2.Body({
          mass: car_mass,
          position: position
      });
      var boxShape = new p2.Box({ width: width, height: height });
      chassisBody.addShape(boxShape);
      world.addBody(chassisBody);

      // Create the vehicle
      vehicle = new p2.TopDownVehicle(chassisBody);

      // Add one front wheel and one back wheel
      frontWheel = vehicle.addWheel({
          localPosition: [0, 0.5] // front
      });
      frontWheel.setSideFriction(4);

      // Back wheel
      backWheel = vehicle.addWheel({
          localPosition: [0, -0.5] // back
      });
      backWheel.setSideFriction(3); // Less side friction on back wheel makes it easier to drift

      backWheel.engineForce = 0.5;
      frontWheel.steerValue = 0.5;

      vehicle.addToWorld(world);
      return vehicle;
    }

    // Create the world
    var world = new p2.World({
        gravity : [0,0]
    });

    // Create p2 cars
    for (i = 0; i < num_cars; i++) {
      position = [0, 0]
      raceCars.push (new RaceCar (world, position, 2*car_width / (i + 1), (i + 1) * car_height, container))
    }

    // Loop the program
    function animate() {
        requestAnimationFrame(animate);
        world.step(fixedTimeStep);

        // Update graphics
        raceCars[0].box_graphic.rotation += 0.1
        updateGraphics (raceCars);

        // console.log(world.time)
        renderer.render(stage);
    }

    // Start animation loop
    requestAnimationFrame(animate);
  </script>
</body>
</html>
